

### 测试1

多个并排的await，其实会顺序执行

```python
import asyncio
import time

async def add(x, y):
    await asyncio.sleep(2)
    return x + y

async def main():
    print('%s: start' % time.strftime('%X'))
    a = await add(1, 1)
    b = await add(10, 10)

    print(f"a: {a} b: {b}")
    print('%s: end' % time.strftime('%X'))
asyncio.run(main())
```

```
15:55:18: start
a: 2 b: 20
15:55:22: end
```

花费了4秒

### 测试2

使用创建任务的方式，才会并行执行

```python
import asyncio
import time

async def add(x, y):
    await asyncio.sleep(2)
    return x + y

async def main():
    print('%s: start' % time.strftime('%X'))
    task1 = asyncio.create_task(add(1, 1))
    task2 = asyncio.create_task(add(10, 10))
    a = await task1
    b = await task2

    print(f"a: {a} b: {b}")
    print('%s: end' % time.strftime('%X'))
asyncio.run(main())
```

```
15:57:07: start
a: 2 b: 20
15:57:09: end
```

花费了2秒

### 测试3

```python
import asyncio
import time

async def add(x, y):
    await asyncio.sleep(2)
    return x + y

async def func1():
    print('task1: start')
    a = await add(1, 1)
    await asyncio.sleep(0.5)
    print('task1: mid')
    b = await add(2, 2)
    print('task1 end')
    
async def func2():
    print('task2: start')
    a = await add(10, 10)
    print('task2: mid')
    b = await add(20, 20)
    print('task2 end')
    
async def main():
    print('%s: start' % time.strftime('%X'))
    task1 = asyncio.create_task(func1())
    task2 = asyncio.create_task(func2())
    await task1
    await task2

    # print(f"a: {a} b: {b}")
    print('%s: end' % time.strftime('%X'))
asyncio.run(main())
```

```
16:03:22: start
task1: start
task2: start
task2: mid
task1: mid
task2 end
task1 end
16:03:26: end
```

4秒完成了本来要8秒的任务





https://docs.python.org/3/library/asyncio-queue.html



## 生产者消费者

```python
#!usr/bin/python
# -*- coding:utf8 -*-
import time
import random
import asyncio


async def consumer(queue, name):
    while True:
        val = await queue.get()
        print(f'{name} get a val: {val} at {time.strftime("%X")}')
        await asyncio.sleep(1)


async def producer(queue, name):
    for i in range(20):
        await queue.put(i)
        print(f'{name} put a val: {i}')
        time.sleep(0.1)


async def main():
    queue = asyncio.Queue()

    tasks = [asyncio.create_task(producer(queue, 'producer'))]
    for i in range(5):
        tasks.append(asyncio.create_task(consumer(queue, f'consumer_{i}')))

    # await asyncio.sleep(10)

    await asyncio.gather(*tasks, return_exceptions=True)


# start = time.perf_counter()
asyncio.run(main())
# end = time.perf_counter()
# print(end - start)

```

https://youaresherlock.blog.csdn.net/article/details/107080094



··