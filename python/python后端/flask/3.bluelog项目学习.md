## 项目环境配置

项目下载

```
git clone git@github.com:greyli/bluelog.git
```

切换到项目路径内创建虚拟环境

```
python -m venv venv
```

linux激活虚拟环境

```
source ./venv/bin/activate
```

windows激活虚拟环境

```
.\venv\Scripts\activate
```

安装依赖包

```
pip install -r requirements.txt
```

启动项目

```
flask forge
flask run
```

访问：http://127.0.0.1:5000/即可看到示例程序

- username: `admin`
- password: `helloflask`

## 大型项目结构

当当某一个模块包含太多代码时，常见的做法是将单一模块升级为包，然后把原模块的内容分离成多个模块。

> 这里的模块指的是py文件，包指的是包含多个py文件的文件夹

例如在这个程序中视图模块就被拆分了

主要文件结构如下

```
  |- bluelog
    |- bluelog
      |- blueprints
        |- __init__.py
        |- admin.py
        |- auth.py
        |- blog.py
      |- static
        |- ckeditor
        |- css
        |- js
        |- favicon.ico
      |- templates
        |- admin
        |- auth
        |- blog
        |- errors
        |- base.html
      |- __init__.py
      |- emails.py
      |- extensions.py
      |- fakes.py
      |- forms.py
      |- models.py
      |- settings.py
      |- utils.py
```

新的脚本文件如下：

- `utils.py`: 用于存储各种辅助函数。
- `fakes.py`: 存储虚拟数据生成函数。
- `emails.py`: 用于存储发送电子邮件的函数。
- `extensions.py`: 用于存储扩展实例化等操作

### 蓝图blueprint

蓝图类似`app`，可以在蓝图上注册路由等操作。

#### 创建蓝图

```python
from flask import Blueprint

auth_bp = Blueprint('auth', __name__)
```

#### 装配蓝图

```python
@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    ...
    
@auth_bp.route('/logout')
def logout():
    ...
```

蓝图也可以错误处理函数、请求处理函数、模板上下文处理函数

等。但是只对这个蓝图下控制的视图函数起作用。

#### 注册蓝图

在`./bluelog/__init__.py`文件中

```python
from bluelog.blueprints.auth import auth_bp
...
app.register_blueprint(auth_bp, url_prefix='/auth')
```

注册后，所有auth蓝图下的视图的URL都会增加一个`/auth`前缀

#### 蓝图的路由端点

在路由里，URL规则和视图函数的映射通过端点连接

```
URL规则  -> 端点    -> 视图函数
/login  -> login   -> login()
```

一般情况下端点名和视图函数同名

使用蓝图的情况下，端点会多一个前缀，这样就可以通过命名空间的形式来避免函数同名的问题。

```
URL规则  ->     端点       -> 视图函数
/login  ->   auth.login   -> login()
```

#### 蓝图资源

如果不同蓝图的页面样式也不同，可以为蓝图定义独有的静态文件和模板。这时我们需要把蓝本模块升级为包，在构造文件中创建蓝本实例，并在蓝本包中创建静态文件文件夹static 和模板文件夹templates 。和程序实例一样，实例化时传人的`__name__`变量会被用来判断蓝本的根目录，并以此作为基础寻找模板文件夹和静态文件文件夹。

定义蓝图时需要指定蓝图的静态文件夹路径

```python
auth_bp = Blueprint('auth', __name__, static_folder='static', static_url_path='auth/static')
```

>如果你在注册蓝本时为蓝图定义了URL 前缀，即设置了url_prefix 参数，那么最终的蓝图静态文件路径会自动设为`／蓝图前缀／static `，这时可以省略static_url_path 的定义。

获取蓝图静态文件URL

```python
url_for('admin.static', filename='style.css')
```

### 使用类组织配置

用于便捷地切换各种不同的配置，例如，开发用的配置，测试用的配置，生产环境用的配置。

比如代码中开发、测试、生产环境下的数据库地址都是不一样的。

`bluelog/settings.py`

```python
class BaseConfig(object):
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev key')
    ...
    
class DevelopmentConfig(BaseConfig):
    ...

class TestingConfig(BaseConfig):
    ...

class ProductionConfig(BaseConfig):
    ...
```

### 使用工厂函数创建程序实例

> 用一个函数创建app
>
> 工厂指创建其他对象的对象。

在`./bluglog/__init__.py`文件内

```python
def create_app(config_name=None):
    if config_name is None:
        config_name = os.getenv('FLASK_CONFIG', 'development')

    app = Flask('bluelog')
    app.config.from_object(config[config_name])

    register_logging(app)
    register_extensions(app)
    register_blueprints(app)
    register_commands(app)
    register_errors(app)
    register_shell_context(app)
    register_template_context(app)
    register_request_handlers(app)
    return app
```

